# UWBä¼ è¾“ä¼˜åŒ– - å¿«é€Ÿå‚è€ƒ

## æ ¸å¿ƒæ”¹åŠ¨

### âœ… å®Œæˆçš„ä¼˜åŒ–

1. **åˆ é™¤é˜Ÿåˆ—æœºåˆ¶**ï¼šä¸å†ä½¿ç”¨ `osMessageQueue`
2. **ä½¿ç”¨å…¨å±€buffer**ï¼š`txBuffer`/`rxBuffer` + äº’æ–¥é”
3. **ç²¾ç®€æ—¥å¿—è¾“å‡º**ï¼šå‡å°‘70%æ—¥å¿—é‡
4. **å‡å°‘æ•°æ®æ‹·è´**ï¼šä»2æ¬¡å‡å°‘åˆ°1æ¬¡
5. **èŠ‚çœå†…å­˜**ï¼šä»30KBå‡å°‘åˆ°2KBï¼ˆèŠ‚çœ93%ï¼‰

## å…³é”®ä»£ç æ”¹åŠ¨

### å‘é€æ•°æ®ï¼ˆåº”ç”¨å±‚è°ƒç”¨ï¼‰

```cpp
// è°ƒç”¨æ–¹å¼ä¸å˜ï¼
uint8_t data[800] = {...};
masterComm.SendData(data, 800, 0);
```

**å†…éƒ¨å®ç°ï¼ˆå·²ä¼˜åŒ–ï¼‰**ï¼š
```cpp
osMutexAcquire(uwbTxMutex, 100);     // åŠ é”
memcpy(txBuffer, data, len);         // æ‹·è´åˆ°å…¨å±€buffer
txBufferLen = len;
osMutexRelease(uwbTxMutex);          // è§£é”
osSemaphoreRelease(uwbTxSemaphore);  // é€šçŸ¥UWBä»»åŠ¡
```

### æ–°çš„æ—¥å¿—æ ¼å¼

#### ä¼˜åŒ–å‰

```
[I] Total conduction test data bytes: 4655 bytes
[D] === Data Fragmentation Info ===
[D] Total fragments: 6
[D] Sending fragment 1/6 in active slot 0 (pin 0)
[I] uwb_comm: tx begin
[I] Fragment sending in progress - currentIndex: 1, totalFragments: 6
[I] Sending fragment 2/6 (size: 800 bytes)
[I] Fragment 2/6 sent successfully
```

#### ä¼˜åŒ–å

```
[I] data: 4655 bytes
[I] 6 frags
[I] tx frag 1/6
[I] uwb_comm: tx #1
[I] tx frag 2/6
[I] uwb_comm: tx #2
[I] tx complete (6 frags)
```

## æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ•°æ®æ‹·è´æ¬¡æ•° | 2æ¬¡ | 1æ¬¡ | **50%** â¬‡ï¸ |
| å†…å­˜å ç”¨ | 30KB | 2KB | **93%** â¬‡ï¸ |
| æ—¥å¿—è¾“å‡ºé‡ | 100% | 30% | **70%** â¬‡ï¸ |
| å“åº”å»¶è¿Ÿ | é˜Ÿåˆ—+æ‹·è´ | ä¿¡å·é‡+ç›´æ¥è¯»å– | **æ›´å¿«** âš¡ |

## æ•°æ®æµå¯¹æ¯”å›¾

### ä¼˜åŒ–å‰ï¼ˆé˜Ÿåˆ—æ–¹å¼ï¼‰

```
åº”ç”¨å±‚: data[800]
   â†“ æ‹·è´1 (800 bytes)
é˜Ÿåˆ—: UwbTxMsg.data[1024]
   â†“ æ‹·è´2 (800 bytes)
UWBä»»åŠ¡: std::vector<uint8_t>
   â†“
UWBå‘é€

æ€»æ‹·è´: 1600 bytes
```

### ä¼˜åŒ–åï¼ˆå…¨å±€bufferæ–¹å¼ï¼‰

```
åº”ç”¨å±‚: data[800]
   â†“ æ‹·è´1 (800 bytes, åŠ é”)
å…¨å±€buffer: txBuffer[1024]
   â†“ ç›´æ¥è¯»å– (åŠ é”)
UWBä»»åŠ¡: std::vector<uint8_t>
   â†“
UWBå‘é€

æ€»æ‹·è´: 800 bytes
```

## é‡è¦æ³¨æ„äº‹é¡¹

### âš ï¸ å¤šä»»åŠ¡å‘é€

å¦‚æœå¤šä¸ªä»»åŠ¡éœ€è¦åŒæ—¶è°ƒç”¨ `SendData()`ï¼š

**ç°è±¡**ï¼šåè°ƒç”¨çš„æ•°æ®ä¼šè¦†ç›–å…ˆè°ƒç”¨çš„æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **æ¨è**ï¼šåœ¨åº”ç”¨å±‚åºåˆ—åŒ–å‘é€ï¼ˆç¡®ä¿ä¸€æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡è°ƒç”¨SendDataï¼‰
2. **å¤‡é€‰**ï¼šæ·»åŠ å‘é€é˜Ÿåˆ—ï¼ˆå¢åŠ å¤æ‚åº¦ï¼Œä½†æœ¬æ¬¡ä¼˜åŒ–å·²åˆ é™¤ï¼‰

**å½“å‰è®¾è®¡**ï¼šé€‚åˆå•ä»»åŠ¡é«˜é¢‘å‘é€çš„åœºæ™¯ï¼ˆå¦‚æ•°æ®é‡‡é›†ä»»åŠ¡ï¼‰

### âœ… çº¿ç¨‹å®‰å…¨

- âœ… äº’æ–¥é”ä¿æŠ¤å…¨å±€buffer
- âœ… ä¿¡å·é‡é€šçŸ¥æœºåˆ¶
- âœ… é€‚åˆå•ç”Ÿäº§è€…-å•æ¶ˆè´¹è€…æ¨¡å¼

## æŸ¥çœ‹æ—¥å¿—å…³é”®å­—

### å‘é€æ•°æ®

```bash
# æŸ¥çœ‹æ•°æ®å¤§å°
grep "data:" log.txt

# æŸ¥çœ‹åˆ†ç‰‡æ•°é‡
grep "frags" log.txt

# æŸ¥çœ‹å‘é€è¿›åº¦
grep "tx frag" log.txt

# æŸ¥çœ‹UWBå®é™…å‘é€
grep "uwb_comm: tx" log.txt

# æŸ¥çœ‹å®ŒæˆçŠ¶æ€
grep "tx complete" log.txt
```

### ç¤ºä¾‹æ—¥å¿—è¾“å‡º

```
[I] data: 4655 bytes          â† æ•°æ®æ€»å¤§å°
[I] 6 frags                   â† åˆ†æˆ6ä¸ªåˆ†ç‰‡
[I] tx frag 1/6               â† å¼€å§‹å‘é€ç¬¬1ç‰‡
[I] uwb_comm: tx #1           â† UWBå®é™…å‘é€ç¬¬1åŒ…
[I] tx frag 2/6               â† å¼€å§‹å‘é€ç¬¬2ç‰‡
[I] uwb_comm: tx #2           â† UWBå®é™…å‘é€ç¬¬2åŒ…
...
[I] tx frag 6/6               â† å¼€å§‹å‘é€ç¬¬6ç‰‡
[I] uwb_comm: tx #6           â† UWBå®é™…å‘é€ç¬¬6åŒ…
[I] tx complete (6 frags)     â† å…¨éƒ¨å‘é€å®Œæˆ
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ•°æ®ä¸¢å¤±

**æ£€æŸ¥**ï¼š
1. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰ "frags > slots" è­¦å‘Š
2. ç¡®è®¤æ‰€æœ‰åˆ†ç‰‡éƒ½æœ‰å¯¹åº”çš„ "tx frag X/Y" æ—¥å¿—
3. ç¡®è®¤æ‰€æœ‰åˆ†ç‰‡éƒ½æœ‰å¯¹åº”çš„ "uwb_comm: tx #X" æ—¥å¿—

**è§£å†³**ï¼š
- å¦‚æœåˆ†ç‰‡æ•°è¶…è¿‡æ¿€æ´»æ—¶éš™æ•°ï¼Œå·²æœ‰è¡¥å¿æœºåˆ¶è‡ªåŠ¨å¤„ç†
- å¦‚æœæŸäº›åˆ†ç‰‡æ²¡æœ‰æ—¥å¿—ï¼Œæ£€æŸ¥SlotManagerçš„æ—¶éš™è·³è¿‡å¤„ç†

### é—®é¢˜ï¼šå‘é€å¡ä½

**æ£€æŸ¥**ï¼š
1. æŸ¥çœ‹æ˜¯å¦æœ‰ "tx frag X/Y failed" é”™è¯¯
2. æ£€æŸ¥UWBä»»åŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. æ£€æŸ¥äº’æ–¥é”æ˜¯å¦æ­»é”

**è§£å†³**ï¼š
- æ£€æŸ¥UWBç¡¬ä»¶çŠ¶æ€
- æŸ¥çœ‹äº’æ–¥é”è·å–è¶…æ—¶è®¾ç½®ï¼ˆé»˜è®¤100msï¼‰

## ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `MasterComm.h` | âœï¸ é‡æ„ | åˆ é™¤é˜Ÿåˆ—ï¼Œæ·»åŠ buffer+é” |
| `MasterComm.cpp` | âœï¸ é‡æ„ | å®ç°æ–°çš„å‘é€/æ¥æ”¶æœºåˆ¶ |
| `slave_device.cpp` | ğŸ“ ä¼˜åŒ– | ç²¾ç®€æ—¥å¿—è¾“å‡º |
| `slot_manager.cpp` | ğŸ› ä¿®å¤ | å¤„ç†æ—¶éš™è·³è¿‡é—®é¢˜ |

## ç¼–è¯‘å’Œæµ‹è¯•

### ç¼–è¯‘

```bash
# åº”è¯¥æ²¡æœ‰ç¼–è¯‘é”™è¯¯
cmake --build build --target all
```

### åŸºæœ¬æµ‹è¯•

1. **å•åŒ…å‘é€**ï¼š
   - å‘é€1ä¸ªåˆ†ç‰‡çš„æ•°æ®ï¼ˆ< 800å­—èŠ‚ï¼‰
   - æŸ¥çœ‹æ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ° "tx frag 1/1" å’Œ "tx complete (1 frag)"

2. **å¤šåŒ…å‘é€**ï¼š
   - å‘é€6ä¸ªåˆ†ç‰‡çš„æ•°æ®ï¼ˆ~4800å­—èŠ‚ï¼‰
   - æŸ¥çœ‹æ—¥å¿—ï¼šåº”è¯¥çœ‹åˆ° "tx frag 1/6" åˆ° "tx frag 6/6"
   - ç¡®è®¤æ‰€æœ‰åˆ†ç‰‡éƒ½æœ‰å¯¹åº”çš„ "uwb_comm: tx #X"

3. **è¿ç»­å‘é€**ï¼š
   - å¤šæ¬¡é‡‡é›†å¹¶å‘é€æ•°æ®
   - ç¡®è®¤æ¯æ¬¡éƒ½èƒ½å®Œæ•´å‘é€

## æ€»ç»“

âœ… **å†…å­˜èŠ‚çœ**ï¼š30KB â†’ 2KBï¼ˆ-93%ï¼‰  
âœ… **æ€§èƒ½æå‡**ï¼šæ‹·è´å‡å°‘50%  
âœ… **æ—¥å¿—ä¼˜åŒ–**ï¼šå‡å°‘70%è¾“å‡º  
âœ… **ä»£ç ç®€åŒ–**ï¼šåˆ é™¤é˜Ÿåˆ—ç®¡ç†  
âœ… **å‘åå…¼å®¹**ï¼šæ¥å£ä¸å˜  

**å»ºè®®**ï¼šç¼–è¯‘åç«‹å³æµ‹è¯•åŸºæœ¬åŠŸèƒ½ï¼Œç¡®ä¿æ•°æ®èƒ½æ­£å¸¸å‘é€å’Œæ¥æ”¶ã€‚
